# 用Python去番剧水印

如题，一些良心番看番送壁纸，但右上角有水印。于是弹幕里充斥着“万恶的水印”“有水印”等等。

我原来用 Ps 去水印，后来发现太低效，于是想找出水印算法，用逆变换还原打水印前的图片。

# 原理

基本思想是摸清加水印的算法，然后逆向求出原图。

经过一晚上的研究，发现以下公式：

ln(255 - s) = c ln(255 - w)

上式中 s 为原图像素，w 为加了水印的像素。c 为常数，对于水印中间的像素取 1.08856，对于没有水印的地方就是 1。可见加水印算法是类似 gamma 变换的算法。

接下来的任务就是对于图片的不同位置的像素，求出对应的常数 c，然后代以上公式。我找 了一张背景几乎纯色的截图作为蒙版。经过 Ps 处理后可以得到一张背景纯色的带水印字样的图片（下图）。

![image](https://github.com/yuchenxi2000/bilibili-watermark/blob/master/mask.png)

利用这张图就可算出 c 值。因为原图已知（去除右上角的图就是原图），带入公式求 c，再根据 c 求要去水印图片的原图即可。

# 效果图

![image](https://github.com/yuchenxi2000/bilibili-watermark/blob/master/example-small.jpg)

去水印前

![image](https://github.com/yuchenxi2000/bilibili-watermark/blob/master/example-out-small.jpg)

去水印后

# 附带的蒙版图

> B站什么时候又搞了个'BiliBili正版'，害得我又做了一张

> 图片肯定和你们的截图大小不一样，自己做吧。

r73_g34_b35_正版.png 来源《伽百璃的堕落》ep.01 08:04

r39_g51_b70_独播.png 来源《天使降临到我身边》ep.09 17:55

# 一些注释

蒙版图命名规则：代码简洁起见，蒙版图片文件名必须包含蒙版图背景的rgb信息。规则是 'r'/'g'/'b' + 像素值，例如 'r39_g51_b70', 'r39g51b70.png', 'maskr39_g51b70.jpg' 都是合法的文件名。

使用时

``` shell
python3.6 main.py -i example.png -o example-out.png -m r39_g51_b70_独播.png
```

自己制作蒙版图：用相同截图方式截一张字样附近几乎纯色的图，把其他地方填充同样的颜色。尽量保留字样周围的像素，不要做处理。对字样周围像素做 Ps 处理会使公式中 c 值发生变化，导致处理出来的图有白边。

# 局限性

对于浅色的图，效果非常不错，但对于深色的图效果不佳。因为深色图 RGB 值过小，最终结果会有色差。转换成 HSV 色彩空间可能可以解决，但我没试过。



yuchenxi2000

2019.10.22